---
// packages/web/src/pages/index.astro
import Layout from '../layouts/Layout.astro';
import { HomePage } from '../components/HomePage';
import { activeTradesRepo, userRepo } from '../lib/repositories';
import { getMockTrades } from '../lib/mock-data';

// Check auth
if (!Astro.locals.user) {
  return Astro.redirect('/login');
}

const user = Astro.locals.user;
const isDevUser = import.meta.env.DEV && user.id === 'dev-user';

// Fetch user data
if (!isDevUser) {
  await userRepo.findOrCreate(user.id, user.email);
}
const trades = isDevUser ? getMockTrades() : await activeTradesRepo.findByUserId(user.id);
---

<Layout title="GePT - My Trades">
  <HomePage
    client:load
    user={{ id: user.id, email: user.email }}
    initialTrades={trades}
  />
</Layout>
