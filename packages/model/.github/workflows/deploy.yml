name: Deploy to Production

on:
  push:
    branches:
      - master
    tags:
      - 'v*.*.*'
    paths-ignore:
      - '**.md'
      - 'docs/**'
  workflow_dispatch:
    inputs:
      environment:
        description: 'Target environment'
        required: true
        default: 'ampere'
        type: choice
        options:
          - ampere
          - all

jobs:
  deploy-ampere:
    name: Deploy to Ampere Server
    runs-on: ubuntu-latest
    env:
      DEPLOY_DIR: /home/ubuntu/gept
      RELEASES_DIR: /home/ubuntu/gept/releases

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'
          cache-dependency-path: requirements.txt

      - name: Install dependencies
        run: pip install -r requirements.txt

      - name: Run tests (safety check)
        run: pytest tests/ -v --tb=short

      - name: Generate version ID
        run: |
          VERSION_ID=$(date -u +%Y%m%d_%H%M%S)
          echo "VERSION_ID=$VERSION_ID" >> $GITHUB_ENV
          echo "Deploying version: $VERSION_ID"

      - name: Setup SSH key
        run: |
          mkdir -p ~/.ssh
          echo "$SSH_PRIVATE_KEY" > ~/.ssh/deploy_key.pem
          chmod 600 ~/.ssh/deploy_key.pem
          ssh-keyscan -H "$SERVER_HOST" >> ~/.ssh/known_hosts
        env:
          SSH_PRIVATE_KEY: ${{ secrets.DEPLOY_SSH_KEY }}
          SERVER_HOST: ${{ secrets.SERVER_HOST }}

      - name: Create release directory
        run: |
          ssh -i ~/.ssh/deploy_key.pem -o StrictHostKeyChecking=no \
            "$SERVER_USER@$SERVER_HOST" \
            "mkdir -p $RELEASES_DIR/$VERSION_ID"
        env:
          SERVER_USER: ${{ secrets.SERVER_USER }}
          SERVER_HOST: ${{ secrets.SERVER_HOST }}

      - name: Transfer source code to release directory
        run: |
          rsync -avz --delete \
            -e "ssh -i ~/.ssh/deploy_key.pem -o StrictHostKeyChecking=no" \
            --exclude '.git' \
            --exclude '__pycache__' \
            --exclude '.pytest_cache' \
            --exclude 'venv' \
            --exclude '.env' \
            --exclude '.secrets' \
            --exclude '*.pyc' \
            --exclude 'models/' \
            --exclude 'data/' \
            --exclude 'logs/' \
            ./ \
            "$SERVER_USER@$SERVER_HOST:$RELEASES_DIR/$VERSION_ID/"
        env:
          SERVER_USER: ${{ secrets.SERVER_USER }}
          SERVER_HOST: ${{ secrets.SERVER_HOST }}

      - name: Record deployment metadata
        env:
          SERVER_USER: ${{ secrets.SERVER_USER }}
          SERVER_HOST: ${{ secrets.SERVER_HOST }}
          GIT_SHA: ${{ github.sha }}
          GIT_REF: ${{ github.ref }}
        run: |
          ssh -i ~/.ssh/deploy_key.pem -o StrictHostKeyChecking=no \
            "$SERVER_USER@$SERVER_HOST" \
            "cat > $RELEASES_DIR/$VERSION_ID/.deploy_info.json << EOF
          {
            \"version\": \"$VERSION_ID\",
            \"deployed_at\": \"$(date -u +%Y-%m-%dT%H:%M:%SZ)\",
            \"deployed_by\": \"github-actions\",
            \"git_commit\": \"$GIT_SHA\",
            \"git_ref\": \"$GIT_REF\"
          }
          EOF"

      - name: Link shared directories (models, logs)
        run: |
          ssh -i ~/.ssh/deploy_key.pem -o StrictHostKeyChecking=no \
            "$SERVER_USER@$SERVER_HOST" \
            "ln -sfn $DEPLOY_DIR/models $RELEASES_DIR/$VERSION_ID/models && \
             ln -sfn $DEPLOY_DIR/logs $RELEASES_DIR/$VERSION_ID/logs"
        env:
          SERVER_USER: ${{ secrets.SERVER_USER }}
          SERVER_HOST: ${{ secrets.SERVER_HOST }}

      - name: Activate new version (atomic symlink switch)
        run: |
          ssh -i ~/.ssh/deploy_key.pem -o StrictHostKeyChecking=no \
            "$SERVER_USER@$SERVER_HOST" \
            "ln -sfn $RELEASES_DIR/$VERSION_ID $DEPLOY_DIR/current.new && \
             mv -T $DEPLOY_DIR/current.new $DEPLOY_DIR/current"
        env:
          SERVER_USER: ${{ secrets.SERVER_USER }}
          SERVER_HOST: ${{ secrets.SERVER_HOST }}

      - name: Install/update dependencies on server
        run: |
          ssh -i ~/.ssh/deploy_key.pem -o StrictHostKeyChecking=no \
            "$SERVER_USER@$SERVER_HOST" \
            "cd $DEPLOY_DIR/current && source $DEPLOY_DIR/venv/bin/activate && pip install -q -r requirements.txt"
        env:
          SERVER_USER: ${{ secrets.SERVER_USER }}
          SERVER_HOST: ${{ secrets.SERVER_HOST }}

      - name: Run database migrations
        run: |
          ssh -i ~/.ssh/deploy_key.pem -o StrictHostKeyChecking=no \
            "$SERVER_USER@$SERVER_HOST" \
            "cd $DEPLOY_DIR/current && set -a && source $DEPLOY_DIR/.env && set +a && \
             if [ -x scripts/migrations/run_migrations.sh ]; then ./scripts/migrations/run_migrations.sh; fi" || true
        env:
          SERVER_USER: ${{ secrets.SERVER_USER }}
          SERVER_HOST: ${{ secrets.SERVER_HOST }}

      - name: Test inference (dry run)
        run: |
          ssh -i ~/.ssh/deploy_key.pem -o StrictHostKeyChecking=no \
            "$SERVER_USER@$SERVER_HOST" \
            "cd $DEPLOY_DIR/current && source $DEPLOY_DIR/venv/bin/activate && \
             set -a && source $DEPLOY_DIR/.env && set +a && \
             timeout 120 python run_inference.py --dry-run"
        env:
          SERVER_USER: ${{ secrets.SERVER_USER }}
          SERVER_HOST: ${{ secrets.SERVER_HOST }}

      - name: Prune old releases (keep last 5)
        run: |
          ssh -i ~/.ssh/deploy_key.pem -o StrictHostKeyChecking=no \
            "$SERVER_USER@$SERVER_HOST" \
            "cd $RELEASES_DIR && ls -1t | tail -n +6 | xargs -r rm -rf"
        env:
          SERVER_USER: ${{ secrets.SERVER_USER }}
          SERVER_HOST: ${{ secrets.SERVER_HOST }}

      - name: Verify deployment
        run: |
          ssh -i ~/.ssh/deploy_key.pem -o StrictHostKeyChecking=no \
            "$SERVER_USER@$SERVER_HOST" \
            "echo '=== Active Version ===' && \
             readlink $DEPLOY_DIR/current && \
             cat $DEPLOY_DIR/current/.deploy_info.json && \
             echo '' && echo '=== Cron Status ===' && \
             crontab -l | grep -v '^#' | grep inference || echo 'No inference cron found'"
        env:
          SERVER_USER: ${{ secrets.SERVER_USER }}
          SERVER_HOST: ${{ secrets.SERVER_HOST }}

      - name: Check recent logs
        if: always()
        run: |
          ssh -i ~/.ssh/deploy_key.pem -o StrictHostKeyChecking=no \
            "$SERVER_USER@$SERVER_HOST" \
            "tail -10 $DEPLOY_DIR/logs/inference.log 2>/dev/null || echo 'No inference logs yet'"
        env:
          SERVER_USER: ${{ secrets.SERVER_USER }}
          SERVER_HOST: ${{ secrets.SERVER_HOST }}

      - name: Cleanup SSH key
        if: always()
        run: rm -f ~/.ssh/deploy_key.pem

  deploy-hydra:
    name: Deploy to Hydra Server
    runs-on: ubuntu-latest
    needs: deploy-ampere
    if: github.event.inputs.environment == 'all'
    env:
      DEPLOY_DIR: /home/ubuntu/gept
      RELEASES_DIR: /home/ubuntu/gept/releases

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Connect to Tailscale
        uses: tailscale/github-action@v2
        with:
          oauth-client-id: ${{ secrets.TS_OAUTH_CLIENT_ID }}
          oauth-secret: ${{ secrets.TS_OAUTH_SECRET }}
          tags: tag:ci

      - name: Generate version ID
        run: |
          VERSION_ID=$(date -u +%Y%m%d_%H%M%S)
          echo "VERSION_ID=$VERSION_ID" >> $GITHUB_ENV

      - name: Setup SSH key
        run: |
          mkdir -p ~/.ssh
          echo "$SSH_PRIVATE_KEY" > ~/.ssh/deploy_key.pem
          chmod 600 ~/.ssh/deploy_key.pem
          ssh-keyscan -H "$SERVER_HOST" >> ~/.ssh/known_hosts
        env:
          SSH_PRIVATE_KEY: ${{ secrets.HYDRA_SSH_KEY }}
          SERVER_HOST: ${{ secrets.HYDRA_HOST }}

      - name: Create release directory
        run: |
          ssh -i ~/.ssh/deploy_key.pem -o StrictHostKeyChecking=no \
            "$SERVER_USER@$SERVER_HOST" \
            "mkdir -p $RELEASES_DIR/$VERSION_ID"
        env:
          SERVER_USER: ${{ secrets.HYDRA_USER }}
          SERVER_HOST: ${{ secrets.HYDRA_HOST }}

      - name: Transfer source code to release directory
        run: |
          rsync -avz --delete \
            -e "ssh -i ~/.ssh/deploy_key.pem -o StrictHostKeyChecking=no" \
            --exclude '.git' \
            --exclude '__pycache__' \
            --exclude '.pytest_cache' \
            --exclude 'venv' \
            --exclude '.env' \
            --exclude '.secrets' \
            --exclude '*.pyc' \
            --exclude 'models/' \
            --exclude 'data/' \
            --exclude 'logs/' \
            ./ \
            "$SERVER_USER@$SERVER_HOST:$RELEASES_DIR/$VERSION_ID/"
        env:
          SERVER_USER: ${{ secrets.HYDRA_USER }}
          SERVER_HOST: ${{ secrets.HYDRA_HOST }}

      - name: Record deployment metadata
        env:
          SERVER_USER: ${{ secrets.HYDRA_USER }}
          SERVER_HOST: ${{ secrets.HYDRA_HOST }}
          GIT_SHA: ${{ github.sha }}
          GIT_REF: ${{ github.ref }}
        run: |
          ssh -i ~/.ssh/deploy_key.pem -o StrictHostKeyChecking=no \
            "$SERVER_USER@$SERVER_HOST" \
            "cat > $RELEASES_DIR/$VERSION_ID/.deploy_info.json << EOF
          {
            \"version\": \"$VERSION_ID\",
            \"deployed_at\": \"$(date -u +%Y-%m-%dT%H:%M:%SZ)\",
            \"deployed_by\": \"github-actions\",
            \"git_commit\": \"$GIT_SHA\",
            \"git_ref\": \"$GIT_REF\"
          }
          EOF"

      - name: Link shared directories (models, logs)
        run: |
          ssh -i ~/.ssh/deploy_key.pem -o StrictHostKeyChecking=no \
            "$SERVER_USER@$SERVER_HOST" \
            "ln -sfn $DEPLOY_DIR/models $RELEASES_DIR/$VERSION_ID/models && \
             ln -sfn $DEPLOY_DIR/logs $RELEASES_DIR/$VERSION_ID/logs"
        env:
          SERVER_USER: ${{ secrets.HYDRA_USER }}
          SERVER_HOST: ${{ secrets.HYDRA_HOST }}

      - name: Activate new version (atomic symlink switch)
        run: |
          ssh -i ~/.ssh/deploy_key.pem -o StrictHostKeyChecking=no \
            "$SERVER_USER@$SERVER_HOST" \
            "ln -sfn $RELEASES_DIR/$VERSION_ID $DEPLOY_DIR/current.new && \
             mv -T $DEPLOY_DIR/current.new $DEPLOY_DIR/current"
        env:
          SERVER_USER: ${{ secrets.HYDRA_USER }}
          SERVER_HOST: ${{ secrets.HYDRA_HOST }}

      - name: Install/update dependencies on server
        run: |
          ssh -i ~/.ssh/deploy_key.pem -o StrictHostKeyChecking=no \
            "$SERVER_USER@$SERVER_HOST" \
            "cd $DEPLOY_DIR/current && source $DEPLOY_DIR/venv/bin/activate && pip install -q -r requirements.txt"
        env:
          SERVER_USER: ${{ secrets.HYDRA_USER }}
          SERVER_HOST: ${{ secrets.HYDRA_HOST }}

      - name: Verify deployment
        run: |
          ssh -i ~/.ssh/deploy_key.pem -o StrictHostKeyChecking=no \
            "$SERVER_USER@$SERVER_HOST" \
            "echo '=== Active Version ===' && \
             readlink $DEPLOY_DIR/current && \
             cat $DEPLOY_DIR/current/.deploy_info.json"
        env:
          SERVER_USER: ${{ secrets.HYDRA_USER }}
          SERVER_HOST: ${{ secrets.HYDRA_HOST }}

      - name: Cleanup SSH key
        if: always()
        run: rm -f ~/.ssh/deploy_key.pem
