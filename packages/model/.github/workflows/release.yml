name: Create Release

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'Version number (e.g., 1.0.0, 2.0.0-beta, 2.0.0-rc.1)'
        required: true
        type: string
      release_notes:
        description: 'Release notes (optional - will auto-generate if empty)'
        required: false
        type: string

jobs:
  release:
    name: Create Release and Deploy
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Validate version format
        env:
          VERSION_INPUT: ${{ github.event.inputs.version }}
        run: |
          if ! [[ "$VERSION_INPUT" =~ ^[0-9]+\.[0-9]+\.[0-9]+(-[a-zA-Z0-9]+(\.[a-zA-Z0-9]+)*)?$ ]]; then
            echo "Error: Version must be in format X.Y.Z or X.Y.Z-prerelease (e.g., 1.0.0, 2.0.0-beta, 2.0.0-rc.1)"
            exit 1
          fi
          echo "VERSION=v$VERSION_INPUT" >> $GITHUB_ENV
          echo "VERSION_NUMBER=$VERSION_INPUT" >> $GITHUB_ENV
          # Check if this is a prerelease version
          if [[ "$VERSION_INPUT" =~ -[a-zA-Z] ]]; then
            echo "IS_PRERELEASE=true" >> $GITHUB_ENV
          else
            echo "IS_PRERELEASE=false" >> $GITHUB_ENV
          fi

      - name: Check if tag already exists
        run: |
          if git rev-parse "$VERSION" >/dev/null 2>&1; then
            echo "Error: Tag $VERSION already exists"
            exit 1
          fi

      - name: Generate release notes
        env:
          CUSTOM_NOTES: ${{ github.event.inputs.release_notes }}
        run: |
          if [ -n "$CUSTOM_NOTES" ]; then
            echo "$CUSTOM_NOTES" > release_notes.md
          else
            LAST_TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "")
            if [ -z "$LAST_TAG" ]; then
              echo "## Changes" > release_notes.md
              echo "" >> release_notes.md
              git log --pretty=format:'- %s (%h)' --no-merges >> release_notes.md
            else
              echo "## Changes since $LAST_TAG" > release_notes.md
              echo "" >> release_notes.md
              git log "$LAST_TAG..HEAD" --pretty=format:'- %s (%h)' --no-merges >> release_notes.md
            fi
          fi

      - name: Create and push tag
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git tag -a "$VERSION" -m "Release $VERSION"
          git push origin "$VERSION"

      - name: Create GitHub Release
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const releaseNotes = fs.readFileSync('release_notes.md', 'utf8');
            const isPrerelease = process.env.IS_PRERELEASE === 'true';
            await github.rest.repos.createRelease({
              owner: context.repo.owner,
              repo: context.repo.repo,
              tag_name: process.env.VERSION,
              name: `Release ${process.env.VERSION}`,
              body: releaseNotes,
              draft: false,
              prerelease: isPrerelease
            });

      - name: Trigger deployment
        run: |
          echo "Deployment will be triggered automatically by the tag push"
          echo "Monitor at: https://github.com/${{ github.repository }}/actions"
